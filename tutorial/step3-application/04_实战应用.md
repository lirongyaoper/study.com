# ç¬¬å››ç« ï¼šTreeç±»å®æˆ˜åº”ç”¨ ğŸš€

é€šè¿‡å‰é¢çš„å­¦ä¹ ï¼Œä½ å·²ç»æŒæ¡äº†Treeç±»çš„åŸºæœ¬åŸç†å’Œæ ¸å¿ƒæ–¹æ³•ã€‚ç°åœ¨è®©æˆ‘ä»¬æ¥çœ‹çœ‹Treeç±»åœ¨å®é™…é¡¹ç›®ä¸­çš„åº”ç”¨åœºæ™¯å’Œæœ€ä½³å®è·µã€‚

## åº”ç”¨åœºæ™¯æ¦‚è§ˆ

| åº”ç”¨åœºæ™¯ | éš¾åº¦ | å¸¸ç”¨æ–¹æ³• | å®é™…ç”¨é€” |
|----------|------|----------|----------|
| ç½‘ç«™å¯¼èˆªèœå• | â­â­ | `getChildren()`, `generateTreeText()` | å¤šçº§å¯¼èˆªèœå•ç”Ÿæˆ |
| å•†å“åˆ†ç±»ç®¡ç† | â­â­â­ | `getAllDescendants()`, `getParent()` | ç”µå•†åˆ†ç±»ä½“ç³» |
| ç»„ç»‡æ¶æ„ç®¡ç† | â­â­ | `getDepth()`, `isLeaf()` | ä¼ä¸šéƒ¨é—¨ç»“æ„ |
| åœ°åŒºç®¡ç†ç³»ç»Ÿ | â­â­â­ | å…¨éƒ¨æ–¹æ³• | çœå¸‚åŒºä¸‰çº§è”åŠ¨ |
| æƒé™èœå•ç³»ç»Ÿ | â­â­â­â­ | é€’å½’+æƒé™è¿‡æ»¤ | åå°ç®¡ç†æƒé™æ§åˆ¶ |
| è®ºå›ç‰ˆå—ç®¡ç† | â­â­ | `getChildren()`, `getDepth()` | è®ºå›ç‰ˆå—åˆ†ç±» |
| æ–‡æ¡£ç›®å½•ç»“æ„ | â­â­â­ | `generateTreeText()` | åœ¨çº¿æ–‡æ¡£å¯¼èˆª |

---

## 1. ç½‘ç«™å¯¼èˆªèœå•ç³»ç»Ÿ ğŸ§­

### åº”ç”¨åœºæ™¯
ä¼ä¸šç½‘ç«™ã€é—¨æˆ·ç½‘ç«™çš„å¤šçº§å¯¼èˆªèœå•ç®¡ç†ã€‚

### æ ¸å¿ƒéœ€æ±‚
- æ”¯æŒæ— é™çº§èœå•
- ç”Ÿæˆå„ç§æ ¼å¼çš„HTMLç»“æ„
- å“åº”å¼èœå•é€‚é…
- å½“å‰ä½ç½®é«˜äº®æ˜¾ç¤º

### å®ç°è¦ç‚¹

```php
// 1. æ•°æ®ç»“æ„è®¾è®¡
$menu_structure = array(
    'id' => 'å”¯ä¸€æ ‡è¯†',
    'parentid' => 'çˆ¶èœå•ID',
    'name' => 'èœå•åç§°',
    'url' => 'é“¾æ¥åœ°å€',
    'icon' => 'å›¾æ ‡ç±»å',
    'target' => 'æ‰“å¼€æ–¹å¼',
    'sort_order' => 'æ’åºå€¼',
    'is_show' => 'æ˜¯å¦æ˜¾ç¤º'
);

// 2. æ°´å¹³å¯¼èˆªèœå•ç”Ÿæˆ
function generateTopNav($tree) {
    $roots = $tree->getRoots();
    $html = '<ul class="nav">';
    
    foreach ($roots as $item) {
        $has_children = !$tree->isLeaf($item['id']);
        $dropdown = $has_children ? ' dropdown' : '';
        
        $html .= "<li class='nav-item{$dropdown}'>";
        $html .= "<a href='{$item['url']}'>{$item['name']}</a>";
        
        if ($has_children) {
            $html .= generateSubMenu($tree, $item['id']);
        }
        
        $html .= '</li>';
    }
    
    $html .= '</ul>';
    return $html;
}

// 3. é¢åŒ…å±‘å¯¼èˆª
function generateBreadcrumb($tree, $current_id) {
    $path = array();
    $temp_id = $current_id;
    
    while ($temp_id != 0 && isset($tree->data[$temp_id])) {
        array_unshift($path, $tree->data[$temp_id]);
        $temp_id = $tree->data[$temp_id]['parentid'];
    }
    
    return implode(' > ', array_column($path, 'name'));
}
```

### å®é™…æ•ˆæœ
```html
<nav class="main-navigation">
    <ul class="nav-list">
        <li class="nav-item dropdown">
            <a href="/products">äº§å“ä¸­å¿ƒ</a>
            <ul class="sub-menu">
                <li><a href="/products/phones">æ™ºèƒ½æ‰‹æœº</a></li>
                <li><a href="/products/tablets">å¹³æ¿ç”µè„‘</a></li>
            </ul>
        </li>
    </ul>
</nav>
```

---

## 2. ç”µå•†å•†å“åˆ†ç±»ç®¡ç† ğŸ›’

### åº”ç”¨åœºæ™¯
ç”µå•†ç½‘ç«™çš„å•†å“åˆ†ç±»ä½“ç³»ï¼Œæ”¯æŒå¤šçº§åˆ†ç±»ç­›é€‰å’Œç®¡ç†ã€‚

### æ ¸å¿ƒéœ€æ±‚
- åˆ†ç±»å±‚çº§ç®¡ç†ï¼ˆå¤§åˆ†ç±»â†’å°åˆ†ç±»â†’å…·ä½“å•†å“ï¼‰
- åˆ†ç±»è·¯å¾„æ˜¾ç¤º
- åŒçº§åˆ†ç±»åˆ‡æ¢
- åˆ†ç±»å•†å“ç»Ÿè®¡

### æ•°æ®æ¨¡å‹

```php
$category_data = array(
    'id' => 'åˆ†ç±»ID',
    'parentid' => 'çˆ¶åˆ†ç±»ID', 
    'name' => 'åˆ†ç±»åç§°',
    'description' => 'åˆ†ç±»æè¿°',
    'image' => 'åˆ†ç±»å›¾ç‰‡',
    'sort_order' => 'æ’åº',
    'product_count' => 'å•†å“æ•°é‡',
    'is_active' => 'æ˜¯å¦å¯ç”¨'
);
```

### å…³é”®åŠŸèƒ½å®ç°

```php
// 1. è·å–åˆ†ç±»è·¯å¾„
function getCategoryPath($tree, $category_id) {
    $path = array();
    $current_id = $category_id;
    
    while ($current_id != 0) {
        if (isset($tree->data[$current_id])) {
            array_unshift($path, $tree->data[$current_id]);
            $current_id = $tree->data[$current_id]['parentid'];
        } else {
            break;
        }
    }
    
    return $path;
}

// 2. ç”Ÿæˆåˆ†ç±»ç­›é€‰å™¨
function generateCategoryFilter($tree, $current_category = 0) {
    $html = '<div class="category-filter">';
    
    // æ˜¾ç¤ºå½“å‰åˆ†ç±»è·¯å¾„
    if ($current_category > 0) {
        $path = getCategoryPath($tree, $current_category);
        $html .= '<div class="current-path">';
        foreach ($path as $index => $cat) {
            if ($index > 0) $html .= ' > ';
            $html .= $cat['name'];
        }
        $html .= '</div>';
    }
    
    // æ˜¾ç¤ºå­åˆ†ç±»é€‰é¡¹
    $children = $tree->getChildren($current_category);
    if ($children) {
        $html .= '<div class="sub-categories">';
        foreach ($children as $child) {
            $html .= "<a href='?category={$child['id']}' class='cat-link'>";
            $html .= "{$child['name']} ({$child['product_count']})";
            $html .= "</a>";
        }
        $html .= '</div>';
    }
    
    $html .= '</div>';
    return $html;
}

// 3. åˆ é™¤åˆ†ç±»ï¼ˆåŒ…å«å­åˆ†ç±»ï¼‰
function deleteCategory($tree, $category_id) {
    $to_delete = array($category_id);
    
    // è·å–æ‰€æœ‰å­åˆ†ç±»
    $descendants = $tree->getAllDescendants($category_id);
    foreach ($descendants as $desc) {
        $to_delete[] = $desc['id'];
    }
    
    // æ‰§è¡Œåˆ é™¤
    foreach ($to_delete as $id) {
        // 1. åˆ é™¤åˆ†ç±»ä¸‹çš„å•†å“æˆ–ç§»åŠ¨åˆ°å…¶ä»–åˆ†ç±»
        // 2. åˆ é™¤åˆ†ç±»æ•°æ®
        echo "åˆ é™¤åˆ†ç±» ID: {$id}\n";
    }
    
    return $to_delete;
}
```

### åº”ç”¨æ•ˆæœ
```
å½“å‰ä½ç½®: ç”µå­äº§å“ > æ‰‹æœº > æ™ºèƒ½æ‰‹æœº

å­åˆ†ç±»:
- iPhone (125ä»¶å•†å“)
- åä¸ºæ‰‹æœº (89ä»¶å•†å“)  
- å°ç±³æ‰‹æœº (156ä»¶å•†å“)
- å…¶ä»–å“ç‰Œ (34ä»¶å•†å“)
```

---

## 3. ä¼ä¸šç»„ç»‡æ¶æ„ç®¡ç† ğŸ¢

### åº”ç”¨åœºæ™¯
ä¼ä¸šå†…éƒ¨çš„éƒ¨é—¨ç»“æ„ç®¡ç†ï¼Œå‘˜å·¥å½’å±å…³ç³»ã€‚

### æ ¸å¿ƒéœ€æ±‚
- éƒ¨é—¨å±‚çº§ç®¡ç†
- å‘˜å·¥éƒ¨é—¨å½’å±
- ç»„ç»‡æ¶æ„å›¾ç”Ÿæˆ
- æƒé™å±‚çº§æ§åˆ¶

### å®ç°ç¤ºä¾‹

```php
// ç»„ç»‡æ¶æ„æ•°æ®ç»“æ„
$department_data = array(
    'id' => 'éƒ¨é—¨ID',
    'parentid' => 'ä¸Šçº§éƒ¨é—¨ID',
    'name' => 'éƒ¨é—¨åç§°',
    'manager' => 'éƒ¨é—¨è´Ÿè´£äºº',
    'employee_count' => 'å‘˜å·¥æ•°é‡',
    'budget' => 'éƒ¨é—¨é¢„ç®—',
    'description' => 'éƒ¨é—¨æè¿°'
);

// ç”Ÿæˆç»„ç»‡æ¶æ„å›¾
function generateOrgChart($tree, $parent_id = 0, $level = 0) {
    $children = $tree->getChildren($parent_id);
    if (!$children) return '';
    
    $html = '<div class="org-level level-' . $level . '">';
    
    foreach ($children as $dept) {
        $employee_count = $dept['employee_count'];
        $has_sub = !$tree->isLeaf($dept['id']);
        
        $html .= '<div class="dept-box">';
        $html .= "<h3>{$dept['name']}</h3>";
        $html .= "<p>è´Ÿè´£äºº: {$dept['manager']}</p>";
        $html .= "<p>å‘˜å·¥: {$employee_count}äºº</p>";
        
        if ($has_sub) {
            $html .= '<div class="sub-departments">';
            $html .= generateOrgChart($tree, $dept['id'], $level + 1);
            $html .= '</div>';
        }
        
        $html .= '</div>';
    }
    
    $html .= '</div>';
    return $html;
}

// è®¡ç®—éƒ¨é—¨å±‚çº§å’Œæ±‡æŠ¥å…³ç³»
function getDepartmentHierarchy($tree, $dept_id) {
    $depth = $tree->getDepth($dept_id);
    $parent = $tree->getParent($dept_id);
    $children = $tree->getChildren($dept_id);
    $all_subordinates = $tree->getAllDescendants($dept_id);
    
    return array(
        'level' => $depth,
        'parent_dept' => $parent ? $parent['name'] : 'æ— ',
        'direct_subdepts' => count($children ?: array()),
        'total_subdepts' => count($all_subordinates ?: array())
    );
}
```

---

## 4. åœ°åŒºç®¡ç†ç³»ç»Ÿ ğŸŒ

### åº”ç”¨åœºæ™¯
çœå¸‚åŒºä¸‰çº§è”åŠ¨é€‰æ‹©ï¼Œåœ°å€ç®¡ç†ç³»ç»Ÿã€‚

### å®ç°è¦ç‚¹

```php
// åœ°åŒºæ•°æ®ç»“æ„
$region_data = array(
    'id' => 'åœ°åŒºä»£ç ',
    'parentid' => 'ä¸Šçº§åœ°åŒºä»£ç ', 
    'name' => 'åœ°åŒºåç§°',
    'level' => 'è¡Œæ”¿çº§åˆ«', // 1çœ 2å¸‚ 3åŒºå¿
    'zipcode' => 'é‚®æ”¿ç¼–ç ',
    'area_code' => 'åŒºå·'
);

// ç”Ÿæˆä¸‰çº§è”åŠ¨é€‰æ‹©å™¨
function generateRegionSelector($tree, $selected_province = 0, $selected_city = 0, $selected_district = 0) {
    $html = '<div class="region-selector">';
    
    // çœä»½é€‰æ‹©
    $provinces = $tree->getChildren(0); // å‡è®¾0æ˜¯æ ¹çº§
    $html .= '<select name="province" onchange="loadCities(this.value)">';
    $html .= '<option value="">è¯·é€‰æ‹©çœä»½</option>';
    foreach ($provinces as $province) {
        $selected = ($province['id'] == $selected_province) ? 'selected' : '';
        $html .= "<option value='{$province['id']}' {$selected}>{$province['name']}</option>";
    }
    $html .= '</select>';
    
    // åŸå¸‚é€‰æ‹©
    $html .= '<select name="city" onchange="loadDistricts(this.value)">';
    if ($selected_province) {
        $cities = $tree->getChildren($selected_province);
        foreach ($cities as $city) {
            $selected = ($city['id'] == $selected_city) ? 'selected' : '';
            $html .= "<option value='{$city['id']}' {$selected}>{$city['name']}</option>";
        }
    }
    $html .= '</select>';
    
    // åŒºå¿é€‰æ‹©
    $html .= '<select name="district">';
    if ($selected_city) {
        $districts = $tree->getChildren($selected_city);
        foreach ($districts as $district) {
            $selected = ($district['id'] == $selected_district) ? 'selected' : '';
            $html .= "<option value='{$district['id']}' {$selected}>{$district['name']}</option>";
        }
    }
    $html .= '</select>';
    
    $html .= '</div>';
    return $html;
}

// AJAXè·å–ä¸‹çº§åœ°åŒº
function getSubRegions($tree, $parent_id) {
    $children = $tree->getChildren($parent_id);
    $result = array();
    
    if ($children) {
        foreach ($children as $child) {
            $result[] = array(
                'id' => $child['id'],
                'name' => $child['name']
            );
        }
    }
    
    return json_encode($result);
}
```

---

## 5. æƒé™èœå•ç³»ç»Ÿ ğŸ”

### åº”ç”¨åœºæ™¯
åå°ç®¡ç†ç³»ç»Ÿçš„æƒé™æ§åˆ¶èœå•ã€‚

### æ ¸å¿ƒç‰¹ç‚¹
- è§’è‰²æƒé™ç®¡ç†
- èœå•åŠ¨æ€è¿‡æ»¤
- æ“ä½œæƒé™æ§åˆ¶

### å®ç°æ–¹æ¡ˆ

```php
// æƒé™èœå•æ•°æ®
$admin_menu = array(
    'id' => 'èœå•ID',
    'parentid' => 'çˆ¶èœå•ID',
    'name' => 'èœå•åç§°',
    'url' => 'æ§åˆ¶å™¨/æ–¹æ³•',
    'permission' => 'æƒé™æ ‡è¯†',
    'icon' => 'å›¾æ ‡',
    'sort_order' => 'æ’åº'
);

// æ ¹æ®ç”¨æˆ·æƒé™è¿‡æ»¤èœå•
function filterMenuByPermission($tree, $user_permissions, $parent_id = 0) {
    $children = $tree->getChildren($parent_id);
    if (!$children) return array();
    
    $filtered = array();
    
    foreach ($children as $child) {
        // æ£€æŸ¥æƒé™
        if (!in_array($child['permission'], $user_permissions)) {
            continue;
        }
        
        // é€’å½’æ£€æŸ¥å­èœå•
        $sub_menus = filterMenuByPermission($tree, $user_permissions, $child['id']);
        
        // å¦‚æœæœ‰å¯è®¿é—®çš„å­èœå•æˆ–æœ¬èº«æ˜¯å¶å­èœå•ï¼Œåˆ™ä¿ç•™
        if ($sub_menus || $tree->isLeaf($child['id'])) {
            $child['children'] = $sub_menus;
            $filtered[] = $child;
        }
    }
    
    return $filtered;
}

// ç”Ÿæˆæƒé™èœå•HTML
function generatePermissionMenu($filtered_menu, $level = 0) {
    if (empty($filtered_menu)) return '';
    
    $html = '<ul class="admin-menu level-' . $level . '">';
    
    foreach ($filtered_menu as $item) {
        $has_children = !empty($item['children']);
        $class = $has_children ? 'has-submenu' : '';
        
        $html .= "<li class='menu-item {$class}'>";
        $html .= "<a href='{$item['url']}'>";
        $html .= "<i class='{$item['icon']}'></i>";
        $html .= "<span>{$item['name']}</span>";
        $html .= "</a>";
        
        if ($has_children) {
            $html .= generatePermissionMenu($item['children'], $level + 1);
        }
        
        $html .= "</li>";
    }
    
    $html .= '</ul>';
    return $html;
}
```

---

## 6. æ€§èƒ½ä¼˜åŒ–æœ€ä½³å®è·µ âš¡

### æ•°æ®åº“å±‚é¢ä¼˜åŒ–

```sql
-- 1. ä¸ºparentidå»ºç«‹ç´¢å¼•
CREATE INDEX idx_parentid ON categories(parentid);

-- 2. ä¸ºå¸¸ç”¨æŸ¥è¯¢å»ºç«‹å¤åˆç´¢å¼•  
CREATE INDEX idx_parent_sort ON categories(parentid, sort_order);

-- 3. ä½¿ç”¨é€‚å½“çš„æ•°æ®ç±»å‹
ALTER TABLE categories MODIFY parentid INT UNSIGNED;
```

### PHPä»£ç ä¼˜åŒ–

```php
// 1. ç¼“å­˜æœºåˆ¶
class CachedTree extends SimpleTree {
    private $cache = array();
    
    public function getChildren($parent_id) {
        if (isset($this->cache['children_' . $parent_id])) {
            return $this->cache['children_' . $parent_id];
        }
        
        $result = parent::getChildren($parent_id);
        $this->cache['children_' . $parent_id] = $result;
        
        return $result;
    }
}

// 2. æ‰¹é‡é¢„åŠ è½½
function preloadTreeData($parent_ids) {
    $sql = "SELECT * FROM categories WHERE parentid IN (" 
         . implode(',', $parent_ids) . ") ORDER BY sort_order";
    return $pdo->query($sql)->fetchAll();
}

// 3. åˆ†é¡µå¤„ç†å¤§æ•°æ®é‡
function getChildrenPaged($tree, $parent_id, $page = 1, $limit = 20) {
    $children = $tree->getChildren($parent_id);
    if (!$children) return array();
    
    $offset = ($page - 1) * $limit;
    return array_slice($children, $offset, $limit, true);
}
```

---

## 7. å¸¸è§é—®é¢˜å’Œè§£å†³æ–¹æ¡ˆ â“

### é—®é¢˜1ï¼šå¾ªç¯å¼•ç”¨
**ç°è±¡**ï¼šAçš„çˆ¶èŠ‚ç‚¹æ˜¯Bï¼ŒBçš„çˆ¶èŠ‚ç‚¹åˆæ˜¯A
**è§£å†³**ï¼šæ·»åŠ å¾ªç¯æ£€æµ‹æœºåˆ¶

```php
function hasCircularReference($data, $id, $new_parent_id) {
    $current_id = $new_parent_id;
    $visited = array();
    
    while ($current_id != 0) {
        if ($current_id == $id || in_array($current_id, $visited)) {
            return true; // å‘ç°å¾ªç¯
        }
        
        $visited[] = $current_id;
        $current_id = isset($data[$current_id]) ? $data[$current_id]['parentid'] : 0;
    }
    
    return false;
}
```

### é—®é¢˜2ï¼šå­¤å„¿èŠ‚ç‚¹
**ç°è±¡**ï¼šèŠ‚ç‚¹çš„çˆ¶èŠ‚ç‚¹ä¸å­˜åœ¨
**è§£å†³**ï¼šæ•°æ®éªŒè¯å’Œä¿®å¤

```php
function findOrphanNodes($data) {
    $orphans = array();
    
    foreach ($data as $id => $item) {
        $parent_id = $item['parentid'];
        if ($parent_id != 0 && !isset($data[$parent_id])) {
            $orphans[] = $id;
        }
    }
    
    return $orphans;
}
```

### é—®é¢˜3ï¼šæ·±åº¦è¿‡æ·±
**ç°è±¡**ï¼šæ ‘å±‚çº§è¿‡å¤šå½±å“æ€§èƒ½å’Œç”¨æˆ·ä½“éªŒ
**è§£å†³**ï¼šé™åˆ¶æœ€å¤§æ·±åº¦

```php
function validateMaxDepth($tree, $max_depth = 10) {
    foreach ($tree->data as $id => $item) {
        if ($tree->getDepth($id) > $max_depth) {
            throw new Exception("èŠ‚ç‚¹ {$id} æ·±åº¦è¶…è¿‡é™åˆ¶");
        }
    }
}
```

---

## æ€»ç»“

Treeç±»åœ¨å®é™…é¡¹ç›®ä¸­åº”ç”¨å¹¿æ³›ï¼Œå…³é”®æ˜¯è¦ï¼š

1. **åˆç†è®¾è®¡æ•°æ®ç»“æ„**ï¼šæ ¹æ®å…·ä½“éœ€æ±‚æ·»åŠ å¿…è¦å­—æ®µ
2. **æ³¨é‡æ€§èƒ½ä¼˜åŒ–**ï¼šä½¿ç”¨ç¼“å­˜ã€ç´¢å¼•ç­‰ä¼˜åŒ–æ‰‹æ®µ
3. **åšå¥½æ•°æ®éªŒè¯**ï¼šé˜²æ­¢å¾ªç¯å¼•ç”¨ã€å­¤å„¿èŠ‚ç‚¹ç­‰é—®é¢˜
4. **è€ƒè™‘ç”¨æˆ·ä½“éªŒ**ï¼šé¿å…å±‚çº§è¿‡æ·±ï¼Œæä¾›å‹å¥½çš„ç•Œé¢

æŒæ¡äº†è¿™äº›å®æˆ˜æŠ€å·§ï¼Œä½ å°±èƒ½åœ¨å®é™…é¡¹ç›®ä¸­çµæ´»è¿ç”¨Treeç±»äº†ï¼

## ä¸‹ä¸€æ­¥

ç°åœ¨ä½ å·²ç»å­¦å®Œäº†Treeç±»çš„å…¨éƒ¨å†…å®¹ï¼š
1. âœ… åŸºç¡€æ¦‚å¿µå’Œæ•°æ®ç»“æ„
2. âœ… æ ¸å¿ƒæ–¹æ³•å’Œä½¿ç”¨æŠ€å·§  
3. âœ… å®æˆ˜åº”ç”¨å’Œæœ€ä½³å®è·µ

æ¥ä¸‹æ¥ä½ å¯ä»¥ï¼š
- å®Œæˆæ‰€æœ‰ç»ƒä¹ é¢˜ç›®
- å°è¯•åœ¨è‡ªå·±çš„é¡¹ç›®ä¸­åº”ç”¨Treeç±»
- å‚è€ƒåŸç‰ˆtree.class.phpå­¦ä¹ æ›´é«˜çº§çš„åŠŸèƒ½
- æ ¹æ®éœ€è¦æ‰©å±•å’Œå®šåˆ¶Treeç±»

ç¥ä½ å­¦ä¹ æ„‰å¿«ï¼ğŸ‰
